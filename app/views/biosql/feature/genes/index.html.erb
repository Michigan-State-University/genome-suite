<% content_for :head do %>
	<%#= render :partial => "common/extjs" %>
	<%#= render :partial => "common/extjs_css_gray" %>
<% end %>

<% content_for :sidebar do %>
	<%= render :partial => "sidebar", :locals => {:active => 'genes'} %>
<% end %>

<% content_for :top_bar do%>
	<h1 class="pagetitle">Gene Models</h1>
<% end %>

<% content_for :item_bar do %>
<!-- Filter / Search items here -->
	<div style="float:left">
		<%= link_to "New Gene", send("new_gene_path"), :class => "button" if can? :create, GeneModel.new%>
	</div>
	<div style="float:right">
	  <% form_tag genes_path, :method => :get do %>
	    Search:<br/>
      <%= text_field_tag "keywords",params[:keywords] %>
      <%= submit_tag 'Go', :class => 'button' %>
	  <% end %>
	</div>
	
	<div class="item_bar_options">
    <span id='arrow_slide_down' style="<%= params[:advanced_search] ? 'display:none' : '' %>">
      <%= image_tag('arrow_slide_down.png',:size => '12x12') %>
    </span>
    <span id='arrow_slide_up' style="<%= params[:advanced_search] ? '' : 'display:none' %>">
      <%= image_tag('arrow_slide_up.png',:size => '12x12') %>
    </span>
    <%= link_to "(Advanced Options)",'#',:onclick => "$('advanced_search').toggle();$('arrow_slide_down').toggle();$('arrow_slide_up').toggle()"%>
  </div>
  
	<br/ style="clear:both">
	<div id='advanced_search' style="<%= params[:advanced_search] ? '' : 'display:none' %>">
	  <br/>
	  <hr/>
	  <br/>
  	<% form_tag genes_path, :method => :get do %>
  	  <%= hidden_field :advanced_search, true %>
      <div style="float:right">
        Keywords:<br/>
        <%= text_field_tag "keywords",params[:keywords], :size => 50 %><br/>
        <br/>
        Taxonomy:<br/>
        <%= select_tag 'assembly_id', options_for_select(@assemblies.collect{|s| [s.name_with_version,s.id]},params[:assembly_id]), {:include_blank => "No Filter"} %><br/>
        <br/>
        <div style="float:left;margin-right:1em">
          Location:<br/>
          <%= text_field_tag "start_pos",params[:start_pos], :size => 10 %>
          TO
          <%= text_field_tag "end_pos",params[:end_pos], :size => 10 %><br/>
        </div>
        <br/style="clear:both"><br/>
          Strand:<br/>
          <%= select_tag 'strand', options_for_select(@search.facet(:strand).rows.collect{|s| ["#{s.value.to_i > 0 ? 'Forward (5\' -> 3\')' : 'Reverse (3\' -> 5\')'} (#{s.count})",s.value]},params[:strand]), {:include_blank => "No Filter"} %><br/>
        <br/>
        <% @presence_items.each do |presence_item| %>
          <div style="float:left;margin-right:1em">
            <%= presence_item.camelize %>:<br/>
            <%= select_tag "#{presence_item}_present",options_for_select([['Present','t'],['Empty','f']],params["#{presence_item}_present".to_sym]), {:include_blank => "No Filter"} %><br/>
          </div>
        <% end %>
      </div>
      <div style="clear:both;float:right;margin:1em">
        <br/>
        <%= submit_tag 'Search', :class => 'button' %>
      </div>
    <% end -%>
  </div>
<% end %>

<% if @search.nil? %>
  No Results Found...
<% else %>
  <div class="pagination">
    <span style="float:left"><%= will_paginate(@search.hits) %></span>
    <span style="float:right;margin-right:2em"><%= number_with_delimiter(@search.total) %> Matching Results</span>
  </div>

  <div class="table">
    <table class="listing">
      <thead>
        <th style="white-space:nowrap;width:10em"><%= sort_link "Locus", 'display_name' %></th>
        <th style="white-space:nowrap"><%= sort_link "Gene Name", 'gene_name' %></th>
        <th style="white-space:nowrap">Function</th>
        <th style="white-space:nowrap">Product</th>
        <th style="white-space:nowrap"><%= sort_link "Start Pos", 'start_pos' %></th>
        <th style="white-space:nowrap"><%= sort_link "End Pos", 'end_pos' %></th>
        <th style="white-space:nowrap"><%= sort_link "Strand", 'strand' %></th>
        <th style="white-space:nowrap"><%= sort_link "Taxon", 'assembly_name_with_version' %></th>
        <th>Options</th>
      </thead>
      <% @search.each_hit_with_result do |hit,feature| %>
      <tr>
        <td><%= highlight_result(hit,:display_name_text) %></td>
        <td><%= highlight_result(hit,:gene_name_text) %></td>
        <td><%= sliced_toggle(highlight_result(hit,:function_text),hit.stored(:function_text).first,"function_text_#{feature.id}") if hit.stored(:function_text).try(:first) %></td>
        <td><%= sliced_toggle(highlight_result(hit,:product_text),hit.stored(:product_text).first,"product_#{feature.id}") if hit.stored(:product_text).try(:first) %></td>
        <td><%= highlight_result(hit,:start_pos) %></td>
        <td><%= highlight_result(hit,:end_pos) %></td>
        <td><%= (hit.stored(:strand) > 0 ? '<span style="color:darkgreen">F</span>' : '<span style="color:darkred">R</span>').html_safe %></td>
        <td style="white-space:nowrap"><%= highlight_result(hit,:assembly_name_with_version_text) %></td>
        <td style="white-space:nowrap">
          <%= link_to 'Details', feature.gene %>
          |
          <%= link_to 'View', bioentry_path(feature.bioentry_id,{:pos => feature.start_pos}) %>
        </td>
      </tr>
      <% end %>
    </table>
  </div>
<% end %>
