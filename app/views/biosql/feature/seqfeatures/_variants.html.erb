<div style="float:left;width:650px">
<p>The entries below correspond to each Variant Sample (SNP, Indel) uploaded for this sequence. The nucleic and protein sequence are computed from the data in each Sample. Click <%= link_to "here",details_variants_path,:popup => true %> for details.</p>
<p>
  You can choose the number of flanking upstream and downstream bases displayed.
  <%= select_tag :window, options_for_select([0,100,500,1000],@variant_window), :onchange => "window.location='#{gene_path(@seqfeature.locus_tag.value)}?fmt=variants&v_win='+this[this.selectedIndex].value+'&v_fmt=#{@variant_format}'"%><br/>
  You can also choose the display format
  <%= select_tag :format, options_for_select(['fasta','standard'],@variant_format), :onchange => "window.location='#{gene_path(@seqfeature.locus_tag.value)}?fmt=variants&v_win=#{@variant_window}&v_fmt='+this[this.selectedIndex].value"%>
</p>
</div>

<div id="variants_text" class="clear">
  <% @seqfeature.bioentry.assembly.variants.each do |variant| %>
    <% variant.samples.each do |sample| %>
        <% unless variant.get_data(variant.get_chrom(@seqfeature.bioentry_id),@seqfeature.min_start,@seqfeature.max_end,{:only_variants => true, :limit => 1}).size > 0 %>
          <div class  = "border">
            <h2 style="font-size:200%"><%= variant.name %></h2>
            No change
          </div>
          <% next %>
        <% end %>
        <div class  = "border">
        <% if @variant_format== 'standard' %>
          <h2 style="font-size:200%"><%= variant.name %> - <span style="font-size:60%;"><%= truncate(variant.description,:length => 120) %></span></h2>
          <table>
            <% if (na_seq = @seqfeature.variant_na_sequence(variant.id,{:window => @variant_window,:html => :true, :sample => sample})) %>
            <tr class  = <%= cycle("odd","even") %>>
              <td class = "keyword">Gene Length</td>
              <td><%= na_seq.size %></td>
            </tr>
            <tr class  = <%= cycle("odd","even") %>>
              <td class = "keyword">NA Sequence</td>
              <% logger.info "\n\n#{na_seq}\n\n" %>
              <td style = "font-family:'Courier';"><pre style="overflow-x:scroll"><%= formatted_sequence(na_seq,{:rows => 9, :delimiter => "<br/>", :match => '<span.*?span>'}) %></pre></td>
            </tr>
            <tr class  = <%= cycle("odd","even") %>>
              <td class = "keyword">Protein Length</td>
              <td><%= (p_seq = @seqfeature.variant_protein_sequence(variant.id,{:window => @variant_window, :sample => sample})).size rescue 0 %></td>
            </tr>
            <tr class  = <%= cycle("odd","even") %>>
              <td class = "keyword">Protein Sequence</td>
              <td style = "font-family:'Courier';"><pre style="overflow-x:scroll"><%= formatted_sequence(p_seq,{:rows => 9, :delimiter => "<br/>"}) rescue ""%></pre></td>
            </tr>
            <% end %>
          </table>
        <% elsif @variant_format == 'fasta' %>
        <h1 class    = "pagetitle" style="font-size:190%">
          <%= variant.name %> 
        </h1>
        <pre style="font-size:110%;overflow-x:scroll">><%= @seqfeature.name %> <%= @seqfeature.bioentry.display_name %> from <%= @seqfeature.min_start - @variant_window %> to <%= @seqfeature.max_end + @variant_window %><br/><%= formatted_sequence(@seqfeature.variant_na_sequence(variant.id,{:window => @variant_window,:html => true, :sample => sample}),{:rows => 10,:per_row => 10,:delimiter => "<br/>", :match => '<span\s\S*span>'}) %>
        </pre>
        <pre style="font-size:110%;overflow-x:scroll">><%= @seqfeature.name %> <%= @seqfeature.bioentry.display_name %> from <%= @seqfeature.min_start - @variant_window %> to <%= @seqfeature.max_end + @variant_window %><br/><%= formatted_sequence(@seqfeature.variant_protein_sequence(variant.id,{:window => @variant_window, :sample => sample}),{:rows => 10,:per_row => 10,:delimiter => "<br/>"}) %>
        </pre>
        <% end %>
      </div>
    <% end #sample%>
  <% end #variant%>
</div>
