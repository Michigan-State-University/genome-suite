<% content_for :head do -%>
  <%= javascript_include_tag 'blast_hsps' %>
<% end -%>
<% content_for :top_bar do -%>
  <h1 class="pagetitle">Blast results for <%= pluralize(@blast_run.blast_reports.count,'query') %></h1>
<% end -%>
<% content_for :sidebar do -%>
  <%= render :partial => "tools/sidebar", :locals => {:active => 'blast'} %>
  <%#= render :partial => "blast_reports/parameters" %>
<% end -%>
<%#= render :partial => "blast_runs/parameters", :locals => {:blast_run => @blast_run} %>
<div class="pagination">
  <span style="float:left"><%= will_paginate(@blast_reports) %></span>
</div>

<div id="blast_alignment" class="blast_alignment" style="display:none; position:absolute; z-index:100; top:0px; left:0px;"></div>

<div class="table">
  <table class="listing grey">
    <thead>
      <th>ID</th>
      <th>Feature ID</th>
      <th>Description</th>
      <th>Query Length</th>
      <th>Hits</th>
      <th>Options</th>
    </thead>
  <% @blast_reports.each_with_index do |blast_report,br_idx| %>
    <tr>
      <td><%= link_to blast_report.report.query_id, blast_run_path(@blast_run,:blast_report_id => blast_report.id)%></td>
      <td><%= link_to blast_report.seqfeature.label, seqfeature_path(blast_report.seqfeature) if blast_report.seqfeature %></td>
      <td><%= blast_report.report.query_def.truncate(50) %></td>
      <td><%= blast_report.report.query_len %></td>
      <td><%= blast_report.report.hits.count %></td>
      <td>
        <%= link_to "Show",'#',
          :onclick => "$('blast_report_#{blast_report.id}').toggle();$('link_#{blast_report.id}_show').toggle();$('link_#{blast_report.id}_hide').toggle()",
          :id => "link_#{blast_report.id}_show",
          :style => "#{br_idx==0 ? 'display:none' : ''}"
        %>
        <%= link_to "Hide",'#',
          :onclick => "$('blast_report_#{blast_report.id}').toggle();$('link_#{blast_report.id}_show').toggle();$('link_#{blast_report.id}_hide').toggle()",
          :id => "link_#{blast_report.id}_hide",
          :style => "#{br_idx==0 ? '': 'display:none'}"
          
        %>
      </td>
    </tr>
    <tr id="blast_report_<%= blast_report.id %>" style="<%= br_idx==0 ? '': 'display:none'%>">
      <td colspan="6">
        <table class="dropdown_blue">
          <% blast_report.report.hits.each_with_index do |hit,idx| %>
            <tr class="even">
              <%= render :partial => 'blast_reports/hit', :locals => {:hit => hit, :idx => idx, :blast_db => @blast_run.blast_database, :blast_report => blast_report} %>
            </tr>
          <% end %>
        </table>
      </td>
    </tr>
  <% end %>
  </table>
</div>

<div style="clear:both" id="color_key" style="width:850px;height:30px;overflow-y:auto">
  <script "text/javascript">
    key = new BlastKey(
      {
        width:800,
        boxHeight:20,
        renderTo:"color_key"
      }
    )
    key.draw();
  </script>
</div>

<% @blast_reports.each do |blast_report| %>
  <div id="blast_report_hsps_<%= blast_report.id %>" style="width:850px;height:300px;overflow-y:auto">
    HSP Hits for: <%= blast_report.report.query_id %> <%= blast_report.report.query_def %>
    <%= number_line(0,800,{:per_pixel => blast_report.report.query_len/800.0,:id => blast_report.id}) %>
    <% hsp_data = blast_report.report.hits.collect{|hit| hit.hsps.collect{|hsp| [hsp.query_from,(hsp.query_to-hsp.query_from),hsp.score]}} %>
    <script "text/javascript">
      graph = new BlastHsp(
        {
          width:800,
          boxHeight:15,
          height:<%= hsp_data.length*15 %>,
          length:<%= blast_report.report.query_len %>,
          renderTo:"blast_report_hsps_<%= blast_report.id %>"
        }
      )
      graph.draw(<%= hsp_data.to_json %>)
    </script>
  </div>
<% end %>

